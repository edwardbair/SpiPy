name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering for testing

jobs:
  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        # Windows build requires nlopt which is challenging to build

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for setuptools-scm

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y swig libnlopt-dev

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install swig nlopt

    - name: Build wheels
      uses: pypa/cibuildwheel@v2.17.0
      env:
        # Build for Python 3.9-3.12
        CIBW_BUILD: cp39-* cp310-* cp311-* cp312-*
        # Skip 32-bit builds and musl (for now)
        CIBW_SKIP: "*-win32 *-manylinux_i686 *-musllinux*"
        # Install dependencies before building
        CIBW_BEFORE_BUILD_LINUX: yum install -y swig nlopt-devel || apt-get install -y swig libnlopt-dev
        CIBW_BEFORE_BUILD_MACOS: brew install swig nlopt
        # Test the wheel
        CIBW_TEST_COMMAND: python -c "import spires; print(spires.__version__)"
        CIBW_TEST_REQUIRES: pytest
        # Build verbosely
        CIBW_BUILD_VERBOSITY: 1

    - uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.os }}
        path: ./wheelhouse/*.whl

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for setuptools-scm

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y swig libnlopt-dev

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build setuptools-scm

    - name: Build sdist
      run: python -m build --sdist

    - uses: actions/upload-artifact@v4
      with:
        name: sdist
        path: dist/*.tar.gz

  publish-pypi:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    # Only publish on tag push or manual workflow dispatch
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write  # Required for trusted publishing

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist
        merge-multiple: true

    - name: List distributions
      run: ls -lh dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        # For testing, use TestPyPI first:
        # repository-url: https://test.pypi.org/legacy/
        # For production, comment out repository-url
        verbose: true
